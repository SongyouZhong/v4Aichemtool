<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ketcher v2.6.2</title>
    <script src="https://unpkg.com/ketcher@2.6.2/dist/ketcher.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/ketcher@2.6.2/dist/ketcher.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #ketcher-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-size: 14px;
            color: #666;
        }
        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="ketcher-container">
        <div id="loading" class="loading-overlay">
            Loading Ketcher Chemical Editor...
        </div>
    </div>
    
    <script>
        let ketcher;
        let isInitialized = false;
        
        // 初始化Ketcher
        async function initKetcher() {
            try {
                const loadingEl = document.getElementById('loading');
                
                // 等待Ketcher库加载完成
                if (typeof window.Ketcher === 'undefined') {
                    setTimeout(initKetcher, 100);
                    return;
                }
                
                const { Editor } = window.Ketcher;
                ketcher = new Editor({
                    element: document.getElementById('ketcher-container'),
                    apiBaseUrl: '',
                    staticResourcesUrl: 'https://unpkg.com/ketcher@2.6.2/dist/',
                });
                
                await ketcher.init();
                
                // 隐藏加载提示
                if (loadingEl) {
                    loadingEl.classList.add('hidden');
                }
                
                isInitialized = true;
                console.log('Ketcher initialized successfully');
                
                // 将ketcher实例和辅助方法暴露到window对象
                window.ketcher = ketcher;
                window.ketcherReady = true;
                
                // 添加一些便捷方法
                window.getKetcherSmiles = async () => {
                    if (!isInitialized) return '';
                    try {
                        return await ketcher.getSmiles();
                    } catch (error) {
                        console.error('Error getting SMILES:', error);
                        return '';
                    }
                };
                
                window.setKetcherMolecule = async (smiles) => {
                    if (!isInitialized) return false;
                    try {
                        await ketcher.setMolecule(smiles);
                        return true;
                    } catch (error) {
                        console.error('Error setting molecule:', error);
                        return false;
                    }
                };
                
                window.clearKetcher = async () => {
                    if (!isInitialized) return false;
                    try {
                        await ketcher.setMolecule('');
                        return true;
                    } catch (error) {
                        console.error('Error clearing molecule:', error);
                        return false;
                    }
                };
                
            } catch (error) {
                console.error('Failed to initialize Ketcher:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.textContent = 'Failed to load Ketcher. Please refresh the page.';
                }
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initKetcher, 100);
        });
        
        // 处理来自父页面的消息
        window.addEventListener('message', async (event) => {
            if (!isInitialized) return;
            
            const { action, data } = event.data;
            let result = null;
            
            try {
                switch (action) {
                    case 'getSmiles':
                        result = await window.getKetcherSmiles();
                        break;
                    case 'setMolecule':
                        result = await window.setKetcherMolecule(data);
                        break;
                    case 'clear':
                        result = await window.clearKetcher();
                        break;
                }
                
                // 发送结果回父页面
                event.source.postMessage({
                    action: action + 'Response',
                    success: true,
                    data: result
                }, event.origin);
            } catch (error) {
                event.source.postMessage({
                    action: action + 'Response',
                    success: false,
                    error: error.message
                }, event.origin);
            }
        });
    </script>
</body>
</html>
